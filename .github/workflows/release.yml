name: release-portable

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_TYPE: Release
  INSTALL_DIR: release

jobs:
  linux-musl-static:
    name: linux-musl-static
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config python3 \
            automake libtool autopoint bison flex texinfo rsync xz-utils zip unzip

      - name: Build depends (musl)
        run: make -C depends -j"$(nproc)" HOST=x86_64-linux-musl

      - name: Prepare env for static pkg-config & toolchain
        run: |
          echo "PKG_CONFIG_LIBDIR=$GITHUB_WORKSPACE/depends/x86_64-linux-musl/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$GITHUB_WORKSPACE/depends/x86_64-linux-musl/lib/pkgconfig" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/depends/x86_64-linux-musl/native/bin" >> $GITHUB_PATH

      - name: Configure (static musl, no wallet/gui)
        run: |
          rm -rf build/musl-static $INSTALL_DIR/linux-x86_64-musl
          cmake -S . -B build/musl-static -G "Unix Makefiles" \
            --toolchain "$GITHUB_WORKSPACE/depends/x86_64-linux-musl/toolchain.cmake" \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/$INSTALL_DIR/linux-x86_64-musl" \
            -DBUILD_GUI=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF \
            -DENABLE_WALLET=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=OFF \
            -DPKG_CONFIG_USE_STATIC_LIBS=ON \
            -DLibevent_USE_STATIC_LIBS=ON \
            -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
            -DCMAKE_EXE_LINKER_FLAGS="-static -static-libstdc++ -static-libgcc -s"

      - name: Build
        run: cmake --build build/musl-static -j"$(nproc)"

      - name: Install
        run: cmake --install build/musl-static

      - name: Verify static binary
        run: |
          set -e
          file $INSTALL_DIR/linux-x86_64-musl/bin/bdtcoind
          if ldd $INSTALL_DIR/linux-x86_64-musl/bin/bdtcoind; then
            echo "ERROR: Linux binary is dynamically linked"; exit 1
          fi
          readelf -d $INSTALL_DIR/linux-x86_64-musl/bin/bdtcoind | grep NEEDED && { echo "ERROR: NEEDED present"; exit 1; } || true

      - name: Package
        run: |
          cd $INSTALL_DIR
          tar -czf bdtcoin-linux-x86_64-musl.tar.gz linux-x86_64-musl
          sha256sum bdtcoin-linux-x86_64-musl.tar.gz > bdtcoin-linux-x86_64-musl.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bdtcoin-linux-x86_64-musl
          path: |
            release/bdtcoin-linux-x86_64-musl.tar.gz
            release/bdtcoin-linux-x86_64-musl.tar.gz.sha256
          if-no-files-found: error

      - name: Publish GitHub Release (tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/bdtcoin-linux-x86_64-musl.tar.gz
            release/bdtcoin-linux-x86_64-musl.tar.gz.sha256

  windows-mingw-static:
    name: windows-mingw-static
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config python3 \
            automake libtool autopoint bison flex texinfo rsync xz-utils zip unzip \
            mingw-w64 binutils-mingw-w64 gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

      - name: Build depends (mingw)
        run: make -C depends -j"$(nproc)" HOST=x86_64-w64-mingw32

      - name: Prepare env for static pkg-config & toolchain
        run: |
          echo "PKG_CONFIG_LIBDIR=$GITHUB_WORKSPACE/depends/x86_64-w64-mingw32/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$GITHUB_WORKSPACE/depends/x86_64-w64-mingw32/lib/pkgconfig" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/depends/x86_64-w64-mingw32/native/bin" >> $GITHUB_PATH

      - name: Configure (mingw, no wallet/gui, static where possible)
        run: |
          rm -rf build/win64 $INSTALL_DIR/windows-x86_64
          cmake -S . -B build/win64 -G "Unix Makefiles" \
            --toolchain "$GITHUB_WORKSPACE/depends/x86_64-w64-mingw32/toolchain.cmake" \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/$INSTALL_DIR/windows-x86_64" \
            -DBUILD_GUI=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF \
            -DENABLE_WALLET=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=OFF \
            -DPKG_CONFIG_USE_STATIC_LIBS=ON \
            -DLibevent_USE_STATIC_LIBS=ON \
            -DCMAKE_FIND_LIBRARY_SUFFIXES=".a" \
            -DCMAKE_EXE_LINKER_FLAGS="-static -static-libstdc++ -static-libgcc -s"

      - name: Build
        run: cmake --build build/win64 -j"$(nproc)"

      - name: Install
        run: cmake --install build/win64

      - name: Strip binaries (Windows)
        run: |
          x86_64-w64-mingw32-strip "$INSTALL_DIR/windows-x86_64/bin/"*.exe || true

      - name: Verify no DLL imports
        run: |
          set -e
          x86_64-w64-mingw32-objdump -p $INSTALL_DIR/windows-x86_64/bin/bdtcoind.exe | grep "DLL Name" && { echo "ERROR: DLL imports present (not fully static)"; exit 1; } || true

      - name: Package
        run: |
          cd $INSTALL_DIR
          zip -r bdtcoin-windows-x86_64.zip windows-x86_64
          sha256sum bdtcoin-windows-x86_64.zip > bdtcoin-windows-x86_64.zip.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bdtcoin-windows-x86_64
          path: |
            release/bdtcoin-windows-x86_64.zip
            release/bdtcoin-windows-x86_64.zip.sha256
          if-no-files-found: error

      - name: Publish GitHub Release (tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/bdtcoin-windows-x86_64.zip
            release/bdtcoin-windows-x86_64.zip.sha256

  macos:
    name: macos-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install prerequisites
        run: |
          brew update
          brew install cmake pkg-config

      - name: Build depends (arm64)
        run: make -C depends -j"$(sysctl -n hw.logicalcpu)" HOST=arm64-apple-darwin

      - name: Prepare env for static pkg-config & toolchain
        run: |
          echo "PKG_CONFIG_LIBDIR=$GITHUB_WORKSPACE/depends/arm64-apple-darwin/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$GITHUB_WORKSPACE/depends/arm64-apple-darwin/lib/pkgconfig" >> $GITHUB_ENV
          echo "$GITHUB_WORKSPACE/depends/arm64-apple-darwin/native/bin" >> $GITHUB_PATH

      - name: Configure (depends toolchain, no wallet/gui)
        run: |
          rm -rf build/macos-arm64 $INSTALL_DIR/macos-arm64
          cmake -S . -B build/macos-arm64 \
          --toolchain "$GITHUB_WORKSPACE/depends/arm64-apple-darwin/toolchain.cmake" \
          -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
          -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/$INSTALL_DIR/macos-arm64" \
          -DBUILD_GUI=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF \
          -DENABLE_WALLET=OFF \
          -DBUILD_SHARED_LIBS=OFF

      - name: Build
        run: cmake --build build/macos-arm64 -j"$(sysctl -n hw.logicalcpu)"

      - name: Install
        run: cmake --install build/macos-arm64

      - name: Strip binaries (macOS)
        run: |
          strip -x "$INSTALL_DIR/macos-arm64/bin/"* || true

      - name: Verify no Homebrew deps
        run: |
          if otool -L "$INSTALL_DIR/macos-arm64/bin/bdtcoind" | grep -q "/opt/homebrew"; then
          echo "ERROR: binary links to Homebrew libs"; exit 1
          fi

      - name: Package
        run: |
          cd $INSTALL_DIR
          tar -czf bdtcoin-macos-${{ matrix.arch }}.tar.gz macos-${{ matrix.arch }}
          shasum -a 256 bdtcoin-macos-${{ matrix.arch }}.tar.gz > bdtcoin-macos-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bdtcoin-macos-arm64
          path: |
            release/bdtcoin-macos-arm64.tar.gz
            release/bdtcoin-macos-arm64.tar.gz.sha256
          if-no-files-found: error

      - name: Publish GitHub Release (tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/bdtcoin-macos-arm64.tar.gz
            release/bdtcoin-macos-arm64.tar.gz.sha256